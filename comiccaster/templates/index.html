{% extends "base.html" %}

{% block title %}ComicCaster - RSS feeds for your favorite comics{% endblock %}

{% block extra_css %}
<style>
    /* Card styling */
    .card {
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .card-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .card-header h2 {
        margin: 0;
        font-size: 1.5rem;
    }

    .card-header p {
        margin: 0.5rem 0 0 0;
        font-size: 0.9rem;
        color: #888;
    }

    .card-body {
        padding: 1rem;
    }

    /* Fixed height table with scrolling */
    .table-container {
        height: 400px;
        overflow-y: scroll; 
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table th {
        background-color: var(--background-color);
        border-bottom: 2px solid var(--border-color);
        padding: 0.75rem;
        font-weight: 600;
        text-align: left;
    }

    .table td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--border-color);
    }

    /* URL styling */
    .feed-url {
        position: relative;
        padding-right: 30px;
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .copy-icon {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    
    .copy-icon:hover {
        opacity: 1;
    }

    /* Comic list for OPML section */
    .comic-list {
        height: 300px;
        overflow-y: scroll;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-bottom: 1rem;
    }

    /* Search inputs */
    #comicSearch, #customFeedSearch {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background: var(--background-color);
        color: var(--text-color);
    }

    .help-text {
        padding: 1rem;
        border-top: 1px solid var(--border-color);
        margin-top: 1rem;
        font-size: 0.9rem;
        color: #888;
    }

    /* Button styling */
    .btn {
        display: inline-block;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        font-weight: 500;
        text-align: center;
        text-decoration: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        border: none;
    }

    .btn-primary {
        background-color: #0066cc;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0052a3;
    }

    .btn-secondary {
        background-color: #666;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #555;
    }

    /* Custom scrollbars */
    .table-container::-webkit-scrollbar,
    .comic-list::-webkit-scrollbar {
        width: 10px;
    }
    
    .table-container::-webkit-scrollbar-track,
    .comic-list::-webkit-scrollbar-track {
        background: #363636;
        border-radius: 4px;
    }
    
    .table-container::-webkit-scrollbar-thumb,
    .comic-list::-webkit-scrollbar-thumb {
        background: #666;
        border-radius: 4px;
    }

    .table-container::-webkit-scrollbar-thumb:hover,
    .comic-list::-webkit-scrollbar-thumb:hover {
        background: #888;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Individual Comic Feeds</h2>
        <p>Subscribe to individual comic feeds</p>
    </div>
    <div class="card-body">
        <input type="text" id="comicSearch" placeholder="Search comics...">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Comic</th>
                        <th>RSS Feed</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody>
                    {% for comic in comics %}
                    <tr>
                        <td>{{ comic.name }}</td>
                        <td>
                            <div class="feed-url">
                                {{ url_for('individual_feed', comic_slug=comic.slug, _external=True) }}
                                <span class="copy-icon" onclick="copyToClipboard(this)" data-url="{{ url_for('individual_feed', comic_slug=comic.slug, _external=True) }}">ðŸ“‹</span>
                            </div>
                        </td>
                        <td><a href="https://www.gocomics.com/{{ comic.slug }}" target="_blank">Source</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>Create OPML File</h2>
        <p>Build a custom collection of comic feeds</p>
    </div>
    <div class="card-body">
        <input type="text" id="customFeedSearch" placeholder="Search comics to add...">
        <div class="comic-list">
            {% for comic in comics %}
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="{{ comic.slug }}" id="comic-{{ comic.slug }}">
                <label class="form-check-label" for="comic-{{ comic.slug }}">
                    {{ comic.name }}
                </label>
            </div>
            {% endfor %}
        </div>

        <button class="btn btn-primary" id="generateFeedBtn">Generate OPML File</button>
        <button class="btn btn-secondary" id="resetSelectionBtn">Reset Selection</button>

        <div class="help-text">
            <p>OPML is a file format that allows you to import multiple RSS feeds at once into your favorite RSS reader. Simply select the comics you want to follow, generate the OPML file, and import it into your RSS reader.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyToClipboard(element) {
        const url = element.getAttribute('data-url');
        navigator.clipboard.writeText(url).then(() => {
            // Visual feedback
            element.textContent = 'âœ“';
            setTimeout(() => {
                element.textContent = 'ðŸ“‹';
            }, 2000);
        }).catch(err => {
            console.error('Could not copy text: ', err);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Comic search functionality
        const comicSearch = document.getElementById('comicSearch');
        const rows = document.querySelectorAll('.table tbody tr');

        comicSearch.addEventListener('keyup', function() {
            const query = this.value.toLowerCase();
            
            rows.forEach(row => {
                const comicName = row.querySelector('td:first-child').textContent.toLowerCase();
                if (comicName.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Custom feed search functionality
        const customFeedSearch = document.getElementById('customFeedSearch');
        const checkboxes = document.querySelectorAll('.form-check');

        customFeedSearch.addEventListener('keyup', function() {
            const query = this.value.toLowerCase();
            
            checkboxes.forEach(checkbox => {
                const comicName = checkbox.querySelector('label').textContent.toLowerCase();
                if (comicName.includes(query)) {
                    checkbox.style.display = '';
                } else {
                    checkbox.style.display = 'none';
                }
            });
        });

        // Generate feed functionality
        const generateFeedBtn = document.getElementById('generateFeedBtn');
        const resetSelectionBtn = document.getElementById('resetSelectionBtn');

        generateFeedBtn.addEventListener('click', function() {
            const selectedComics = [];
            document.querySelectorAll('.form-check-input:checked').forEach(checkbox => {
                selectedComics.push(checkbox.value);
            });

            if (selectedComics.length === 0) {
                alert('Please select at least one comic.');
                return;
            }

            // Call the API to generate the feed
            fetch('/generate-feed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    comics: selectedComics
                }),
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Network response was not ok.');
            })
            .then(blob => {
                // Create a link to download the file
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'comiccaster-feeds.opml';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('There was an error generating your feed. Please try again.');
            });
        });

        resetSelectionBtn.addEventListener('click', function() {
            document.querySelectorAll('.form-check-input:checked').forEach(checkbox => {
                checkbox.checked = false;
            });
        });
    });
</script>
{% endblock %} 